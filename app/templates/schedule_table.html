{% extends 'base.html' %}
{% set title = 'æ’ç­è¡¨' %}

{% block head %}
<style>
.schedule-container {
  max-width: 100%;
  overflow-x: auto;
}

.schedule-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 2rem;
  background: white;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.schedule-table th,
.schedule-table td {
  padding: 12px 8px;
  text-align: center;
  border: 1px solid #e0e0e0;
  font-size: 14px;
}

.schedule-table th {
  background: #6be3ff;
  color: white;
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 10;
}

.schedule-table tr:nth-child(even) {
  background-color: #f8f9fa;
}

.schedule-table tr:hover {
  background-color: #e3f2fd;
}

.table-title {
  background: #495057;
  color: white;
  padding: 12px;
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.filter-section {
  background: white;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.filter-input {
  width: 100%;
  max-width: 300px;
  padding: 10px;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  font-size: 16px;
}

.filter-input:focus {
  outline: none;
  border-color: #6be3ff;
  box-shadow: 0 0 0 3px rgba(107, 227, 255, 0.1);
}

.highlight {
  background-color: #fff3cd;
  font-weight: 600;
}

.week-info {
  background: #e3f2fd;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  border-left: 4px solid #6be3ff;
}

@media (max-width: 768px) {
  .schedule-table {
    font-size: 12px;
  }
  
  .schedule-table th,
  .schedule-table td {
    padding: 8px 4px;
  }
  
  .filter-input {
    max-width: 100%;
  }
}
</style>
{% endblock %}

{% block content %}
<section class="py-4">
  <div class="container-fluid">
    <div class="week-info">
      <h2 class="mb-2">æ’ç­æ—¶é—´è¡¨ - {{ schedule_data.week }}</h2>
      <p class="mb-0">å…è´£:è¯·ä»¥åŒ»é™¢é€šçŸ¥ä¸ºå‡†,æœ¬å¹³å°ä»…æä¾›æ’ç­ä¿¡æ¯è§£æå·¥å…·,ä¸æ‰¿æ‹…ä»»ä½•è´£ä»»</p>
    </div>

    <!-- ç­›é€‰åŒºåŸŸ -->
    <div class="filter-section">
      <div class="row align-items-center">
        <div class="col-md-6">
          <label for="nameFilter" class="form-label">æŒ‰å§“åç­›é€‰ï¼š</label>
          <input type="text" id="nameFilter" class="form-control filter-input" 
                 placeholder="è¾“å…¥å§“åè¿›è¡Œç­›é€‰..." autocomplete="off">
        </div>
        <div class="col-md-6">
          <div class="d-flex gap-2 align-items-end">
            <button type="button" class="btn btn-outline-secondary" onclick="clearFilter()">
              ğŸ—‘ï¸ æ¸…é™¤ç­›é€‰
            </button>
            <button type="button" class="btn btn-outline-info" onclick="exportToCSV()">
              ğŸ“Š å¯¼å‡ºCSV
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- æ’ç­è¡¨ -->
    <div class="schedule-container">
      {% for table in schedule_data.tables %}
      <div class="mb-4">
        <h3 class="table-title">{{ table.title }}</h3>
        <table class="schedule-table" data-table="{{ table.title }}">
          <thead>
            <tr>
              <th>å²—ä½</th>
              <th>æ—¶é—´</th>
              {% for date in table.dates %}
              <th>{{ date }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for shift in table.shifts %}
            <tr>
              <td><strong>{{ shift.position }}</strong></td>
              <td>{{ shift.time_range }}</td>
              {% for date in table.dates %}
              <td class="name-cell" data-name="{{ shift.assignments.get(date, '') }}">
                {{ shift.assignments.get(date, '') }}
              </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endfor %}
    </div>

    <!-- è¿”å›æŒ‰é’® -->
    <div class="text-center mt-4">
      <a href="/insider" class="btn btn-primary">
        â† è¿”å›å†…éƒ¨é¡µé¢
      </a>
    </div>
  </div>
</section>

<script>
// å§“åç­›é€‰åŠŸèƒ½
document.getElementById('nameFilter').addEventListener('input', function(e) {
  const filterValue = e.target.value.toLowerCase().trim();
  const tables = document.querySelectorAll('.schedule-table');
  
  tables.forEach(table => {
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
      const nameCells = row.querySelectorAll('.name-cell');
      let hasMatch = false;
      
      // æ£€æŸ¥è¿™ä¸€è¡Œæ˜¯å¦æœ‰åŒ¹é…çš„å•å…ƒæ ¼
      nameCells.forEach(cell => {
        const name = cell.getAttribute('data-name').toLowerCase();
        const text = cell.textContent.toLowerCase();
        
        if (filterValue === '' || name.includes(filterValue) || text.includes(filterValue)) {
          cell.classList.add('highlight');
          hasMatch = true;
        } else {
          cell.classList.remove('highlight');
        }
      });
      
      // æ ¹æ®æ˜¯å¦æœ‰åŒ¹é…æ¥å†³å®šæ˜¾ç¤ºæˆ–éšè—æ•´è¡Œ
      if (filterValue === '' || hasMatch) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });
});

// æ¸…é™¤ç­›é€‰
function clearFilter() {
  document.getElementById('nameFilter').value = '';
  const nameCells = document.querySelectorAll('.name-cell');
  const rows = document.querySelectorAll('.schedule-table tbody tr');
  
  nameCells.forEach(cell => {
    cell.classList.remove('highlight');
  });
  
  rows.forEach(row => {
    row.style.display = '';
  });
}

// å¯¼å‡ºCSVåŠŸèƒ½
function exportToCSV() {
  const tables = document.querySelectorAll('.schedule-table');
  let csvContent = 'data:text/csv;charset=utf-8,';
  
  tables.forEach(table => {
    const tableTitle = table.getAttribute('data-table');
    csvContent += `\n${tableTitle}\n`;
    
    const rows = table.querySelectorAll('tr');
    rows.forEach(row => {
      const cells = row.querySelectorAll('th, td');
      const rowData = Array.from(cells).map(cell => {
        const text = cell.textContent.replace(/"/g, '""');
        return `"${text}"`;
      });
      csvContent += rowData.join(',') + '\n';
    });
  });
  
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement('a');
  link.setAttribute('href', encodedUri);
  link.setAttribute('download', `æ’ç­è¡¨_${new Date().toISOString().slice(0,10)}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–åˆå§‹åŒ–é€»è¾‘
  console.log('æ’ç­è¡¨é¡µé¢åŠ è½½å®Œæˆ');
});
</script>
{% endblock %} 