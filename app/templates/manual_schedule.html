{% extends 'base.html' %}
{% set title = 'æ‰‹åŠ¨å¡«å†™æ’ç­è¡¨' %}

{% block head %}
<style>
/* æ‰‹åŠ¨å¡«å†™é¡µé¢æ ·å¼ */
.manual-schedule-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.schedule-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

.schedule-table th,
.schedule-table td {
  border: 1px solid #dee2e6;
  padding: 8px 12px;
  text-align: center;
}

.schedule-table th {
  background-color: #f8f9fa;
  font-weight: 600;
}

.schedule-table input,
.schedule-table select {
  width: 100%;
  border: none;
  padding: 4px 8px;
  text-align: center;
  background: transparent;
}

.schedule-table input:focus,
.schedule-table select:focus {
  outline: 2px solid #6be3ff;
  background: #ffffff;
}

.add-row-btn {
  background-color: #28a745;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

.add-row-btn:hover {
  background-color: #218838;
}

.remove-row-btn {
  background-color: #dc3545;
  color: white;
  border: none;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}

.remove-row-btn:hover {
  background-color: #c82333;
}

.week-selector {
  margin-bottom: 30px;
}

.week-selector select {
  padding: 12px 16px;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  font-size: 16px;
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.week-selector select:focus {
  border-color: #6be3ff;
  box-shadow: 0 0 0 0.2rem rgba(107, 227, 255, 0.25);
  background: #ffffff;
}

.table-section {
  margin-bottom: 40px;
}

.table-header {
  display: flex;
  justify-content: between;
  align-items: center;
  margin-bottom: 15px;
}

.table-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: #495057;
  margin: 0;
}

.submit-section {
  padding-top: 30px;
  border-top: 2px solid #e9ecef;
  text-align: center;
}

.btn-primary {
  background-color: #6be3ff;
  border-color: #6be3ff;
  padding: 12px 30px;
  font-size: 16px;
  font-weight: 600;
}

.btn-primary:hover {
  background-color: #5dd1ed;
  border-color: #5dd1ed;
}

/* æ˜ŸæœŸèƒŒæ™¯è‰² */
.weekday-0 { background-color: #ffe6e6; } /* å‘¨æ—¥ - æ·¡çº¢è‰² */
.weekday-1 { background-color: #e6f2ff; } /* å‘¨ä¸€ - æ·¡è“è‰² */
.weekday-2 { background-color: #e6ffe6; } /* å‘¨äºŒ - æ·¡ç»¿è‰² */
.weekday-3 { background-color: #fff2e6; } /* å‘¨ä¸‰ - æ·¡æ©™è‰² */
.weekday-4 { background-color: #f2e6ff; } /* å‘¨å›› - æ·¡ç´«è‰² */
.weekday-5 { background-color: #ffffe6; } /* å‘¨äº” - æ·¡é»„è‰² */
.weekday-6 { background-color: #f0f8ff; } /* å‘¨å…­ - æ·¡é’è‰² */

/* ç§»åŠ¨ç«¯ä¼˜åŒ– */
@media (max-width: 768px) {
  .manual-schedule-container {
    padding: 10px;
  }
  
  .schedule-table {
    font-size: 14px;
  }
  
  .schedule-table th,
  .schedule-table td {
    padding: 6px 8px;
  }
  
  .schedule-table input,
  .schedule-table select {
    font-size: 14px;
    padding: 2px 4px;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="manual-schedule-container">
  <h2 class="mb-4">æ‰‹åŠ¨å¡«å†™æ’ç­è¡¨</h2>
  
  {% if error %}
  <div class="alert alert-danger" role="alert">{{ error }}</div>
  {% endif %}
  
  {% if success %}
  <div class="alert alert-success" role="alert">{{ success }}</div>
  {% endif %}

  <form method="post" action="{{ url_for('manual_schedule') }}" id="manualScheduleForm">
    <!-- å‘¨æ¬¡é€‰æ‹© -->
    <div class="week-selector">
      <label for="weekSelect" class="form-label">é€‰æ‹©æ’ç­å‘¨æ¬¡ï¼š</label>
      <select id="weekSelect" name="week" class="form-select" required>
        <option value="">è¯·é€‰æ‹©æ’ç­å‘¨æ¬¡</option>
      </select>
    </div>

    <!-- æ’ç­è¡¨æ ¼ï¼ˆåˆå¹¶åçš„ç»Ÿä¸€è¡¨æ ¼ï¼‰ -->
    <div class="table-section">
      <div class="table-header">
        <h3 class="table-title">æ’ç­è¡¨</h3>
        <button type="button" class="add-row-btn" onclick="addScheduleRow()">+ å¢åŠ ä¸€è¡Œ</button>
      </div>
      <div class="table-responsive">
        <table class="schedule-table" id="scheduleTable">
          <thead>
            <tr>
              <th width="120">æ—¥æœŸ</th>
              <th width="120">ç­æ¬¡</th>
              <th width="120">å²—ä½</th>
              <th width="80">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="scheduleTableBody">
            <!-- è¡¨æ ¼è¡Œå°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- æäº¤æŒ‰é’® -->
    <div class="submit-section">
      <button type="submit" class="btn btn-primary">ğŸ“¤ æäº¤ä¿å­˜</button>
      <a href="{{ url_for('insider') }}" class="btn btn-link">â† è¿”å›ä¸Šçº§é¡µé¢</a>
    </div>
  </form>
</div>

<script>
// ç­æ¬¡é€‰é¡¹ï¼ˆåˆå¹¶æ‰€æœ‰ç­æ¬¡é€‰é¡¹ï¼‰
const SHIFT_OPTIONS = ['ä¸Šåˆ', 'ä¸‹åˆ', 'æ™šç­', 'å¤œç­', 'å…¨å¤©'];

// å²—ä½é€‰é¡¹
const POSITION_OPTIONS = [
  // MRå²—ä½
  'MR1', 'MR2', 'MR3', 'MR4', 'MR5', 'MR6', 'MR7', 'MR8', 'MR9', 'MR10', 'MR11', 'MR12', 'MR13',
  // CTå²—ä½
  'CT1', 'CT2', 'CT3', 'CT4', 'CT5', 'CT6', 'CT7', 'CT8', 'CT9', 'CT10', 'CT11', 'CT12', 'CT13'
];

let scheduleRowCount = 0;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  loadWeekOptions();
  
  // æ·»åŠ åˆå§‹è¡Œ
  addScheduleRow();
  
  // è¡¨å•æäº¤å¤„ç†
  const form = document.getElementById('manualScheduleForm');
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const weekSelect = document.getElementById('weekSelect');
    if (!weekSelect.value) {
      alert('è¯·é€‰æ‹©æ’ç­å‘¨æ¬¡');
      return;
    }
    
    // æ”¶é›†è¡¨å•æ•°æ®
    const formData = collectFormData();
    if (!formData) {
      return; // éªŒè¯å¤±è´¥
    }
    
    // æäº¤æ•°æ®
    submitScheduleData(formData);
  });
});

// åŠ è½½å‘¨æ¬¡é€‰é¡¹
function loadWeekOptions() {
  fetch('/api/week-options')
    .then(response => response.json())
    .then(data => {
      const weekSelect = document.getElementById('weekSelect');
      weekSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ’ç­å‘¨æ¬¡</option>';
      
      // åªæ˜¾ç¤º2025å¹´çš„é€‰é¡¹
      const filteredOptions = data.week_options.filter(option => {
        return option.label && option.label.includes('2025');
      });
      
      filteredOptions.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option.value;
        optionElement.textContent = option.label;
        weekSelect.appendChild(optionElement);
      });
    })
    .catch(error => {
      console.error('åŠ è½½å‘¨æ¬¡é€‰é¡¹å¤±è´¥:', error);
      const weekSelect = document.getElementById('weekSelect');
      weekSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</option>';
    });
}

// æ·»åŠ æ’ç­è¡Œï¼ˆåˆå¹¶åçš„ç»Ÿä¸€å‡½æ•°ï¼‰
function addScheduleRow() {
  scheduleRowCount++;
  const tbody = document.getElementById('scheduleTableBody');
  const row = document.createElement('tr');
  row.innerHTML = `
    <td><input type="date" name="schedule_date_${scheduleRowCount}" required></td>
    <td>
      <select name="schedule_shift_${scheduleRowCount}" required>
        <option value="">é€‰æ‹©ç­æ¬¡</option>
        ${SHIFT_OPTIONS.map(shift => `<option value="${shift}">${shift}</option>`).join('')}
      </select>
    </td>
    <td>
      <select name="schedule_position_${scheduleRowCount}" required>
        <option value="">é€‰æ‹©å²—ä½</option>
        ${POSITION_OPTIONS.map(position => `<option value="${position}">${position}</option>`).join('')}
      </select>
    </td>
    <td><button type="button" class="remove-row-btn" onclick="removeRow(this)">åˆ é™¤</button></td>
  `;
  tbody.appendChild(row);
  
  // ä¸ºæ—¥æœŸè¾“å…¥æ¡†æ·»åŠ å˜åŒ–ç›‘å¬å™¨
  const dateInput = row.querySelector('input[type="date"]');
  dateInput.addEventListener('change', function() {
    setRowBackgroundByDate(row, this.value);
  });
}

// åˆ é™¤è¡Œ
function removeRow(button) {
  const row = button.closest('tr');
  row.remove();
}

// æ ¹æ®æ—¥æœŸè®¾ç½®è¡ŒèƒŒæ™¯è‰²
function setRowBackgroundByDate(row, dateString) {
  if (!dateString) return;
  
  const date = new Date(dateString);
  const weekday = date.getDay(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­
  
  // æ¸…é™¤æ‰€æœ‰æ˜ŸæœŸæ ·å¼ç±»
  for (let i = 0; i <= 6; i++) {
    row.classList.remove(`weekday-${i}`);
  }
  
  // æ·»åŠ å¯¹åº”æ˜ŸæœŸçš„æ ·å¼ç±»
  row.classList.add(`weekday-${weekday}`);
}

// æ”¶é›†è¡¨å•æ•°æ®
function collectFormData() {
  const week = document.getElementById('weekSelect').value;
  
  if (!week) {
    alert('è¯·é€‰æ‹©æ’ç­å‘¨æ¬¡');
    return null;
  }
  
  const scheduleData = [];
  
  // æ”¶é›†æ‰€æœ‰æ’ç­æ•°æ®
  for (let i = 1; i <= scheduleRowCount; i++) {
    const dateInput = document.querySelector(`input[name="schedule_date_${i}"]`);
    const shiftSelect = document.querySelector(`select[name="schedule_shift_${i}"]`);
    const positionSelect = document.querySelector(`select[name="schedule_position_${i}"]`);
    
    if (dateInput && dateInput.closest('tr')) { // æ£€æŸ¥è¡Œæ˜¯å¦è¿˜å­˜åœ¨
      if (dateInput.value && shiftSelect.value && positionSelect.value) {
        scheduleData.push({
          date: dateInput.value,
          shift: shiftSelect.value,
          position: positionSelect.value,
          staff: 'å¼ ç'
        });
      }
    }
  }
  
  if (scheduleData.length === 0) {
    alert('è¯·è‡³å°‘å¡«å†™ä¸€è¡Œæ’ç­æ•°æ®');
    return null;
  }
  
  return {
    week: week,
    schedule_data: scheduleData
  };
}

// æäº¤æ’ç­æ•°æ®
function submitScheduleData(formData) {
  const submitBtn = document.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  
  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> ä¿å­˜ä¸­...';
  
  fetch('/api/manual-schedule', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(formData)
  })
  .then(response => {
    if (response.ok) {
      return response.json();
    } else {
      throw new Error('æäº¤å¤±è´¥');
    }
  })
  .then(data => {
    if (data.success) {
      alert('æ’ç­è¡¨ä¿å­˜æˆåŠŸï¼');
      // é‡å®šå‘åˆ°æ’ç­æŸ¥çœ‹é¡µé¢
      window.location.href = `/schedule?week=${encodeURIComponent(formData.week)}`;
    } else {
      throw new Error(data.error || 'ä¿å­˜å¤±è´¥');
    }
  })
  .catch(error => {
    console.error('æäº¤å¤±è´¥:', error);
    alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ï¼š' + error.message);
  })
  .finally(() => {
    // æ¢å¤æŒ‰é’®çŠ¶æ€
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
  });
}
</script>
{% endblock %}
