{% extends 'base.html' %}
{% set title = '手动填写排班表' %}

{% block head %}
<style>
/* 手动填写页面样式 */
.manual-schedule-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.schedule-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

.schedule-table th,
.schedule-table td {
  border: 1px solid #dee2e6;
  padding: 8px 12px;
  text-align: center;
}

.schedule-table th {
  background-color: #f8f9fa;
  font-weight: 600;
}

.schedule-table input,
.schedule-table select {
  width: 100%;
  border: none;
  padding: 4px 8px;
  text-align: center;
  background: transparent;
}

.schedule-table input:focus,
.schedule-table select:focus {
  outline: 2px solid #6be3ff;
  background: #ffffff;
}

.add-row-btn {
  background-color: #28a745;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

.add-row-btn:hover {
  background-color: #218838;
}

.remove-row-btn {
  background-color: #dc3545;
  color: white;
  border: none;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}

.remove-row-btn:hover {
  background-color: #c82333;
}

.week-selector {
  margin-bottom: 30px;
}

.week-selector select {
  padding: 12px 16px;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  font-size: 16px;
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.week-selector select:focus {
  border-color: #6be3ff;
  box-shadow: 0 0 0 0.2rem rgba(107, 227, 255, 0.25);
  background: #ffffff;
}

.table-section {
  margin-bottom: 40px;
}

.table-header {
  display: flex;
  justify-content: between;
  align-items: center;
  margin-bottom: 15px;
}

.table-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: #495057;
  margin: 0;
}

.submit-section {
  padding-top: 30px;
  border-top: 2px solid #e9ecef;
  text-align: center;
}

.btn-primary {
  background-color: #6be3ff;
  border-color: #6be3ff;
  padding: 12px 30px;
  font-size: 16px;
  font-weight: 600;
}

.btn-primary:hover {
  background-color: #5dd1ed;
  border-color: #5dd1ed;
}

/* 星期背景色 */
.weekday-0 { background-color: #ffe6e6; } /* 周日 - 淡红色 */
.weekday-1 { background-color: #e6f2ff; } /* 周一 - 淡蓝色 */
.weekday-2 { background-color: #e6ffe6; } /* 周二 - 淡绿色 */
.weekday-3 { background-color: #fff2e6; } /* 周三 - 淡橙色 */
.weekday-4 { background-color: #f2e6ff; } /* 周四 - 淡紫色 */
.weekday-5 { background-color: #ffffe6; } /* 周五 - 淡黄色 */
.weekday-6 { background-color: #f0f8ff; } /* 周六 - 淡青色 */

/* 移动端优化 */
@media (max-width: 768px) {
  .manual-schedule-container {
    padding: 10px;
  }
  
  .schedule-table {
    font-size: 14px;
  }
  
  .schedule-table th,
  .schedule-table td {
    padding: 6px 8px;
  }
  
  .schedule-table input,
  .schedule-table select {
    font-size: 14px;
    padding: 2px 4px;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="manual-schedule-container">
  <h2 class="mb-4">手动填写排班表</h2>
  
  {% if error %}
  <div class="alert alert-danger" role="alert">{{ error }}</div>
  {% endif %}
  
  {% if success %}
  <div class="alert alert-success" role="alert">{{ success }}</div>
  {% endif %}

  <form method="post" action="{{ url_for('manual_schedule') }}" id="manualScheduleForm">
    <!-- 周次选择 -->
    <div class="week-selector">
      <label for="weekSelect" class="form-label">选择排班周次：</label>
      <select id="weekSelect" name="week" class="form-select" required>
        <option value="">请选择排班周次</option>
      </select>
    </div>

    <!-- 排班表格（合并后的统一表格） -->
    <div class="table-section">
      <div class="table-header">
        <h3 class="table-title">排班表</h3>
        <button type="button" class="add-row-btn" onclick="addScheduleRow()">+ 增加一行</button>
      </div>
      <div class="table-responsive">
        <table class="schedule-table" id="scheduleTable">
          <thead>
            <tr>
              <th width="120">日期</th>
              <th width="120">班次</th>
              <th width="120">岗位</th>
              <th width="80">操作</th>
            </tr>
          </thead>
          <tbody id="scheduleTableBody">
            <!-- 表格行将通过JavaScript动态添加 -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- 提交按钮 -->
    <div class="submit-section">
      <button type="submit" class="btn btn-primary">📤 提交保存</button>
      <a href="{{ url_for('insider') }}" class="btn btn-link">← 返回上级页面</a>
    </div>
  </form>
</div>

<script>
// 班次选项（合并所有班次选项）
const SHIFT_OPTIONS = ['上午', '下午', '晚班', '夜班', '全天'];

// 岗位选项
const POSITION_OPTIONS = [
  // MR岗位
  'MR1', 'MR2', 'MR3', 'MR4', 'MR5', 'MR6', 'MR7', 'MR8', 'MR9', 'MR10', 'MR11', 'MR12', 'MR13',
  // CT岗位
  'CT1', 'CT2', 'CT3', 'CT4', 'CT5', 'CT6', 'CT7', 'CT8', 'CT9', 'CT10', 'CT11', 'CT12', 'CT13'
];

let scheduleRowCount = 0;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
  loadWeekOptions();
  
  // 添加初始行
  addScheduleRow();
  
  // 表单提交处理
  const form = document.getElementById('manualScheduleForm');
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const weekSelect = document.getElementById('weekSelect');
    if (!weekSelect.value) {
      alert('请选择排班周次');
      return;
    }
    
    // 收集表单数据
    const formData = collectFormData();
    if (!formData) {
      return; // 验证失败
    }
    
    // 提交数据
    submitScheduleData(formData);
  });
});

// 加载周次选项
function loadWeekOptions() {
  fetch('/api/week-options')
    .then(response => response.json())
    .then(data => {
      const weekSelect = document.getElementById('weekSelect');
      weekSelect.innerHTML = '<option value="">请选择排班周次</option>';
      
      // 只显示2025年的选项
      const filteredOptions = data.week_options.filter(option => {
        return option.label && option.label.includes('2025');
      });
      
      filteredOptions.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option.value;
        optionElement.textContent = option.label;
        weekSelect.appendChild(optionElement);
      });
    })
    .catch(error => {
      console.error('加载周次选项失败:', error);
      const weekSelect = document.getElementById('weekSelect');
      weekSelect.innerHTML = '<option value="">加载失败，请刷新重试</option>';
    });
}

// 添加排班行（合并后的统一函数）
function addScheduleRow() {
  scheduleRowCount++;
  const tbody = document.getElementById('scheduleTableBody');
  const row = document.createElement('tr');
  row.innerHTML = `
    <td><input type="date" name="schedule_date_${scheduleRowCount}" required></td>
    <td>
      <select name="schedule_shift_${scheduleRowCount}" required>
        <option value="">选择班次</option>
        ${SHIFT_OPTIONS.map(shift => `<option value="${shift}">${shift}</option>`).join('')}
      </select>
    </td>
    <td>
      <select name="schedule_position_${scheduleRowCount}" required>
        <option value="">选择岗位</option>
        ${POSITION_OPTIONS.map(position => `<option value="${position}">${position}</option>`).join('')}
      </select>
    </td>
    <td><button type="button" class="remove-row-btn" onclick="removeRow(this)">删除</button></td>
  `;
  tbody.appendChild(row);
  
  // 为日期输入框添加变化监听器
  const dateInput = row.querySelector('input[type="date"]');
  dateInput.addEventListener('change', function() {
    setRowBackgroundByDate(row, this.value);
  });
}

// 删除行
function removeRow(button) {
  const row = button.closest('tr');
  row.remove();
}

// 根据日期设置行背景色
function setRowBackgroundByDate(row, dateString) {
  if (!dateString) return;
  
  const date = new Date(dateString);
  const weekday = date.getDay(); // 0=周日, 1=周一, ..., 6=周六
  
  // 清除所有星期样式类
  for (let i = 0; i <= 6; i++) {
    row.classList.remove(`weekday-${i}`);
  }
  
  // 添加对应星期的样式类
  row.classList.add(`weekday-${weekday}`);
}

// 收集表单数据
function collectFormData() {
  const week = document.getElementById('weekSelect').value;
  
  if (!week) {
    alert('请选择排班周次');
    return null;
  }
  
  const scheduleData = [];
  
  // 收集所有排班数据
  for (let i = 1; i <= scheduleRowCount; i++) {
    const dateInput = document.querySelector(`input[name="schedule_date_${i}"]`);
    const shiftSelect = document.querySelector(`select[name="schedule_shift_${i}"]`);
    const positionSelect = document.querySelector(`select[name="schedule_position_${i}"]`);
    
    if (dateInput && dateInput.closest('tr')) { // 检查行是否还存在
      if (dateInput.value && shiftSelect.value && positionSelect.value) {
        scheduleData.push({
          date: dateInput.value,
          shift: shiftSelect.value,
          position: positionSelect.value,
          staff: '张珍'
        });
      }
    }
  }
  
  if (scheduleData.length === 0) {
    alert('请至少填写一行排班数据');
    return null;
  }
  
  return {
    week: week,
    schedule_data: scheduleData
  };
}

// 提交排班数据
function submitScheduleData(formData) {
  const submitBtn = document.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  
  // 显示加载状态
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 保存中...';
  
  fetch('/api/manual-schedule', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(formData)
  })
  .then(response => {
    if (response.ok) {
      return response.json();
    } else {
      throw new Error('提交失败');
    }
  })
  .then(data => {
    if (data.success) {
      alert('排班表保存成功！');
      // 重定向到排班查看页面
      window.location.href = `/schedule?week=${encodeURIComponent(formData.week)}`;
    } else {
      throw new Error(data.error || '保存失败');
    }
  })
  .catch(error => {
    console.error('提交失败:', error);
    alert('保存失败，请重试：' + error.message);
  })
  .finally(() => {
    // 恢复按钮状态
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
  });
}
</script>
{% endblock %}
